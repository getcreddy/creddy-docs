# API Reference

Creddy exposes a REST API for credential management.

## Base URL

```
http://localhost:8080/api/v1
```

## Authentication

All endpoints (except enrollment initiation and health) require request signing. See [Client Authentication](/docs/authentication) for details.

```
X-Creddy-Client: cli_xyz789
X-Creddy-Timestamp: 1708531200
X-Creddy-Signature: base64(...)
```

---

## Enrollment Endpoints

### Initiate Enrollment

Start the enrollment process for a new client. No authentication required.

```
POST /api/v1/enrollments
```

#### Request Body

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `public_key` | string | Yes | Base64-encoded Ed25519 public key |
| `name` | string | Yes | Human-readable client name |
| `metadata` | object | No | Client metadata (hostname, user, OS) |

#### Example Request

```bash
curl -X POST http://localhost:8080/api/v1/enrollments \
  -H "Content-Type: application/json" \
  -d '{
    "public_key": "MCowBQYDK2VwAyEA...",
    "name": "my-laptop",
    "metadata": {
      "hostname": "marcbook.local",
      "username": "marc",
      "os": "darwin",
      "arch": "arm64"
    }
  }'
```

#### Response

```json
{
  "enrollment_id": "enr_abc123",
  "status": "pending",
  "expires_at": "2024-01-15T16:05:00Z",
  "poll_interval_ms": 2000
}
```

---

### Poll Enrollment Status

Check if an enrollment has been approved.

```
GET /api/v1/enrollments/{enrollment_id}/status
```

#### Response (Pending)

```json
{
  "status": "pending",
  "expires_at": "2024-01-15T16:05:00Z"
}
```

#### Response (Approved)

```json
{
  "status": "approved",
  "client_id": "cli_xyz789",
  "server_public_key": "MCowBQYDK2VwAyEA..."
}
```

#### Response (Denied)

```json
{
  "status": "denied",
  "reason": "Unknown device"
}
```

---

### List Pending Enrollments (Admin)

```
GET /api/v1/admin/enrollments?status=pending
```

#### Response

```json
{
  "enrollments": [
    {
      "enrollment_id": "enr_abc123",
      "name": "my-laptop",
      "public_key_fingerprint": "SHA256:xK3E8f...",
      "metadata": {
        "hostname": "marcbook.local",
        "username": "marc"
      },
      "requested_at": "2024-01-15T16:00:00Z",
      "expires_at": "2024-01-15T16:05:00Z",
      "ip_address": "192.168.1.50"
    }
  ]
}
```

---

### Approve Enrollment (Admin)

```
POST /api/v1/admin/enrollments/{enrollment_id}/approve
```

#### Request Body

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `role` | string | No | Client role: `operator` (default) or `admin` |
| `note` | string | No | Admin note |

#### Response

```json
{
  "client_id": "cli_xyz789",
  "status": "approved"
}
```

---

### Deny Enrollment (Admin)

```
POST /api/v1/admin/enrollments/{enrollment_id}/deny
```

#### Request Body

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reason` | string | No | Reason for denial |

---

## Credential Endpoints

### Issue Credential

Issue a new ephemeral credential.

```
POST /api/v1/credentials
```

#### Request Body

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `backend` | string | Yes | Backend identifier |
| `ttl` | string | No | Time to live (e.g., "1h", "30m") |
| `scopes` | string[] | No | Requested scopes |
| `metadata` | object | No | Custom metadata for audit |

#### Example Request

```bash
curl -X POST http://localhost:8080/api/v1/credentials \
  -H "Content-Type: application/json" \
  -H "X-Creddy-Client: cli_xyz789" \
  -H "X-Creddy-Timestamp: 1708531200" \
  -H "X-Creddy-Signature: ..." \
  -d '{
    "backend": "github",
    "ttl": "1h",
    "scopes": ["repo:read", "issues:write"]
  }'
```

#### Response

```json
{
  "id": "cred_abc123",
  "token": "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9...",
  "backend": "github",
  "scopes": ["repo:read", "issues:write"],
  "expires_at": "2024-01-15T16:00:00Z",
  "created_at": "2024-01-15T15:00:00Z"
}
```

---

### Get Credential

Retrieve credential metadata (not the token itself).

```
GET /api/v1/credentials/{id}
```

#### Response

```json
{
  "id": "cred_abc123",
  "backend": "github",
  "scopes": ["repo:read"],
  "expires_at": "2024-01-15T16:00:00Z",
  "created_at": "2024-01-15T15:00:00Z",
  "revoked": false
}
```

---

### Revoke Credential

Revoke a credential before expiration.

```
DELETE /api/v1/credentials/{id}
```

#### Response

```json
{
  "id": "cred_abc123",
  "revoked": true,
  "revoked_at": "2024-01-15T15:30:00Z"
}
```

---

## Client Management (Admin)

### List Clients

```
GET /api/v1/admin/clients
```

#### Response

```json
{
  "clients": [
    {
      "client_id": "cli_xyz789",
      "name": "my-laptop",
      "role": "operator",
      "public_key_fingerprint": "SHA256:xK3E8f...",
      "created_at": "2024-01-15T15:00:00Z",
      "last_seen": "2024-01-15T16:30:00Z",
      "status": "active"
    }
  ]
}
```

---

### Revoke Client

```
DELETE /api/v1/admin/clients/{client_id}
```

#### Response

```json
{
  "client_id": "cli_xyz789",
  "status": "revoked",
  "revoked_at": "2024-01-15T16:00:00Z"
}
```

---

## Backend Endpoints

### List Backends

```
GET /api/v1/backends
```

#### Response

```json
{
  "backends": [
    {
      "id": "github",
      "type": "github",
      "default_ttl": "1h",
      "max_ttl": "24h",
      "allowed_scopes": ["repo:*", "issues:*"]
    }
  ]
}
```

---

### Get Backend

```
GET /api/v1/backends/{id}
```

---

## Other Endpoints

### Health Check

```
GET /health
```

No authentication required.

#### Response

```json
{
  "status": "healthy",
  "version": "0.1.0"
}
```

---

### Audit Log

```
GET /api/v1/audit
```

#### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `backend` | string | Filter by backend |
| `client_id` | string | Filter by client |
| `since` | string | Start time (ISO 8601 or duration) |
| `until` | string | End time |
| `limit` | int | Max results (default 100) |

---

## Error Responses

All errors follow this format:

```json
{
  "error": {
    "code": "invalid_request",
    "message": "Backend 'unknown' not found"
  }
}
```

### Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `invalid_request` | 400 | Invalid request body or parameters |
| `unauthorized` | 401 | Missing or invalid authentication |
| `forbidden` | 403 | Insufficient permissions |
| `not_found` | 404 | Resource not found |
| `enrollment_expired` | 410 | Enrollment request has expired |
| `enrollment_denied` | 403 | Enrollment was denied |
| `client_revoked` | 403 | Client has been revoked |
| `internal_error` | 500 | Server error |
