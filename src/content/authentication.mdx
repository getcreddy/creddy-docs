# Client Authentication

Creddy uses public-key cryptography for client authentication. No shared secrets are stored after initial enrollment.

## How It Works

1. **Client generates a keypair** â€” Ed25519 keys are generated locally
2. **Client requests enrollment** â€” Sends public key to server
3. **Admin approves** â€” Via CLI, Slack, or other integration
4. **Client is activated** â€” All requests are now signed with the private key

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚  1. Generate keypair      â”‚             â”‚
â”‚             â”‚  2. Send public key â”€â”€â”€â”€â–¶ â”‚   Creddy    â”‚
â”‚             â”‚                           â”‚   Server    â”‚
â”‚             â”‚  (pending approval)       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ 3. Notify admin
                                                 â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   Admin     â”‚
                                          â”‚  (CLI/Slack)â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ 4. Approve
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚  5. Enrollment complete   â”‚   Creddy    â”‚
â”‚             â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Server    â”‚
â”‚             â”‚                           â”‚             â”‚
â”‚             â”‚  6. Signed requests â”€â”€â”€â”€â–¶ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Enrolling a Client

### Step 1: Enroll the Client

```bash
$ creddy enroll https://creddy.example.com --name my-laptop

Generating keypair... done
Registering with server... done

Waiting for approval...
  Name:        my-laptop
  Fingerprint: SHA256:xK3E8f...
  Expires:     4:58 remaining

Ask an admin to approve, or run:
  creddy admin approve enr_abc123

â£¾ Waiting for approval... (4:32 remaining)

âœ“ Approved by admin@example.com
âœ“ Client registered: cli_xyz789
âœ“ Credentials saved to ~/.config/creddy/

Ready. Try: creddy backends
```

The client generates an Ed25519 keypair and sends the public key to the server. The enrollment request is held in a "pending" state until an admin approves it.

### Step 2: Admin Approval

Admins can approve enrollments via CLI:

```bash
# List pending enrollments
$ creddy admin enrollments

ID            NAME        USER    HOST              IP              EXPIRES
enr_abc123    my-laptop   marc    marcbook.local    192.168.1.50    4:32

# Approve
$ creddy admin approve enr_abc123
âœ“ Approved my-laptop (cli_xyz789)

# Or deny
$ creddy admin deny enr_abc123 --reason "unknown device"
âœ— Denied my-laptop
```

Or via Slack (if configured):

```
ğŸ”‘ New Client Enrollment Request

Name:        my-laptop
User:        marc  
Host:        marcbook.local
IP:          192.168.1.50
Fingerprint: SHA256:xK3E8f...

â±ï¸ Expires in 5 minutes

[âœ“ Approve]  [âœ— Deny]
```

## Request Signing

After enrollment, all API requests are signed with the client's private key:

```
POST /api/v1/credentials HTTP/1.1
Host: creddy.example.com
X-Creddy-Client: cli_xyz789
X-Creddy-Timestamp: 1708531200
X-Creddy-Signature: base64(ed25519_sign(client_id + timestamp + method + path + body_hash))
Content-Type: application/json

{"backend": "github", "ttl": "1h"}
```

The server verifies:
1. Client ID exists and is active
2. Timestamp is within 5 minutes of server time
3. Signature is valid for the request

## Client Roles

Clients can have different roles:

| Role | Permissions |
|------|-------------|
| `operator` | Request credentials, list backends |
| `admin` | All operator permissions + manage enrollments, configure backends |

Assign a role when approving:

```bash
$ creddy admin approve enr_abc123 --role admin
```

Default role is `operator`.

## Stored Credentials

Client credentials are stored in `~/.config/creddy/`:

```
~/.config/creddy/
â”œâ”€â”€ config.yaml      # Server URL, client ID
â”œâ”€â”€ client.key       # Ed25519 private key (mode 0600)
â””â”€â”€ client_id        # Client identifier
```

The private key never leaves the client machine.

## Key Rotation

To rotate a client's keypair:

```bash
$ creddy rotate-key

Generating new keypair... done
Requesting key rotation... done

New fingerprint: SHA256:yL4F9g...
Old key will remain valid for 24 hours.

âœ“ Key rotation complete
```

The server accepts both old and new keys during the grace period.

## Revoking Clients

Admins can revoke a client's access:

```bash
$ creddy admin clients

ID            NAME        ROLE      LAST SEEN           STATUS
cli_xyz789    my-laptop   operator  2024-01-15 15:30    active
cli_abc123    ci-runner   operator  2024-01-15 14:00    active

$ creddy admin revoke cli_xyz789
âœ“ Revoked my-laptop
```

Revoked clients cannot make any API requests.

## Bootstrap Admin

On first server start, you need at least one admin. Options:

### Option 1: Config File

Add your public key fingerprint to the server config:

```yaml
# creddy-server.yaml
admins:
  - fingerprint: "SHA256:xK3E8f..."
```

### Option 2: Bootstrap Token

Server generates a one-time admin token on first start:

```bash
$ creddy server
No admin configured. Bootstrap token (single use):
  ctk_XXXXXXXXXXXXX

Run on your machine:
  creddy init --admin-token ctk_XXXXXXXXXXXXX
```

## Auto-Approve Rules

For CI/CD environments, you can configure auto-approve rules:

```yaml
# creddy-server.yaml
enrollment:
  auto_approve:
    - cidr: 10.0.0.0/8           # Internal network
    - hostname_pattern: "ci-*"   # CI runners
  
  # Enrollments expire after this duration
  pending_ttl: 5m
```

Auto-approved clients get the `operator` role by default.
