# Anthropic Integration

Creddy's Anthropic plugin provides ephemeral access tokens via a built-in proxy. Agents get short-lived `crd_xxx` tokens that work through the proxy, while Creddy manages your actual API key.

## How It Works

```
┌─────────────┐    creddy get anthropic    ┌─────────────┐
│   Agent     │ ─────────────────────────▶ │   Creddy    │
│             │ ◀───────────────────────── │   Server    │
└─────────────┘    crd_xxx (10 min TTL)    └──────┬──────┘
       │                                          │
       │ API calls via proxy                      │ Validates token
       ▼                                          │ Swaps for real key
┌─────────────┐                            ┌──────┴──────┐
│   Plugin    │ ─────────────────────────▶ │  Anthropic  │
│   Proxy     │    sk-ant-xxx (your key)   │     API     │
└─────────────┘                            └─────────────┘
```

1. Agent requests `creddy get anthropic`
2. Plugin generates a short-lived `crd_xxx` token
3. Agent configures `ANTHROPIC_BASE_URL` to point at the proxy
4. Agent makes API calls with the `crd_xxx` token
5. Proxy validates the token, swaps it for your real API key, forwards to Anthropic
6. On TTL expiry or revocation → token stops working immediately

**Key benefits:**
- Your real API key never leaves the server
- Tokens can be instantly revoked
- Full audit trail of which agent used what, when

## Requirements

- Anthropic API key (`sk-ant-...`) from [console.anthropic.com](https://console.anthropic.com/)

## Installation

```bash
creddy plugin install anthropic
```

## Server Setup

Add the backend with your Anthropic API key:

```bash
creddy backend add anthropic
```

You'll be prompted for your API key:

```
Adding backend 'anthropic'...

api_key (Anthropic API key): sk-ant-api03-xxxxx

✓ Backend 'anthropic' added.
  Proxy running on :8401
```

Or pass it directly:

```bash
creddy backend add anthropic --api-key sk-ant-api03-xxxxx
```

### Proxy Port

The plugin runs a proxy server (default port 8401). To use a different port:

```bash
creddy backend add anthropic --api-key sk-ant-xxx --proxy-port 9000
```

## Agent Enrollment

Agents request Anthropic access during enrollment:

```bash
creddy enroll --server http://creddy:8400 --name my-agent \
  --can anthropic
```

## Requesting Tokens

Once enrolled and approved:

```bash
# Get a token (default 10 min TTL)
creddy get anthropic

# Get a token with custom TTL (max 1 hour)
creddy get anthropic --ttl 30m
```

## Using the Proxy

The proxy endpoint is `http://creddy-host:8401` (or your custom port).

### Environment Setup

```bash
export ANTHROPIC_API_KEY=$(creddy get anthropic)
export ANTHROPIC_BASE_URL=http://creddy-host:8401
```

### With Claude CLI

```bash
export ANTHROPIC_API_KEY=$(creddy get anthropic --ttl 1h)
export ANTHROPIC_BASE_URL=http://creddy-host:8401

claude "Hello, world"
```

### With Python SDK

```python
import anthropic

client = anthropic.Anthropic(
    api_key="crd_xxx",  # from creddy get
    base_url="http://creddy-host:8401"
)

message = client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=1024,
    messages=[{"role": "user", "content": "Hello!"}]
)
```

### With curl

```bash
TOKEN=$(creddy get anthropic)

curl http://creddy-host:8401/v1/messages \
  -H "Content-Type: application/json" \
  -H "x-api-key: $TOKEN" \
  -H "anthropic-version: 2023-06-01" \
  -d '{
    "model": "claude-sonnet-4-20250514",
    "max_tokens": 256,
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

## Token Lifecycle

### TTL Constraints

- **Minimum TTL:** 1 minute
- **Maximum TTL:** 1 hour
- **Default TTL:** 10 minutes

### Expiry

When a token's TTL expires, the proxy immediately rejects it:

```bash
# Request a 5-minute token
creddy get anthropic --ttl 5m

# After 5 minutes, requests fail:
curl http://creddy-host:8401/v1/messages -H "x-api-key: crd_xxx"
# 401 Unauthorized: token expired
```

### Revocation

When an agent is unenrolled, all their tokens are immediately invalidated:

```bash
creddy unenroll my-agent
# All crd_xxx tokens for my-agent stop working
```

## Streaming Support

The proxy fully supports SSE streaming for `/v1/messages`:

```python
import anthropic

client = anthropic.Anthropic(
    api_key="crd_xxx",
    base_url="http://creddy-host:8401"
)

with client.messages.stream(
    model="claude-sonnet-4-20250514",
    max_tokens=1024,
    messages=[{"role": "user", "content": "Write a haiku"}]
) as stream:
    for text in stream.text_stream:
        print(text, end="", flush=True)
```

## Security Considerations

### API Key Protection

Your real API key (`sk-ant-xxx`) is:
- Stored encrypted in Creddy's database
- Never exposed to agents
- Only used server-side by the proxy

### Token Security

`crd_xxx` tokens are:
- Short-lived (max 1 hour)
- Scoped to specific agents
- Instantly revocable
- Only valid through the Creddy proxy (not directly with Anthropic)

### Network Security

The proxy should only be accessible to authorized agents:
- Run Creddy on a private network or Tailscale
- Use firewall rules to restrict access
- Consider TLS termination in front of the proxy

## Comparison with Direct API Keys

| Aspect | Direct API Key | Creddy Proxy |
|--------|---------------|--------------|
| Lifetime | Forever | Minutes to hours |
| Revocation | Manual in Console | Instant via CLI |
| Key exposure | Agents see real key | Agents see `crd_xxx` only |
| Audit | Check Console | Full trail in Creddy |
| Agent compromise | Full API access | Limited window + revoke |

## Troubleshooting

### "401 Unauthorized" from proxy

Check token validity:
```bash
# Is the token format correct?
echo $ANTHROPIC_API_KEY  # Should be crd_xxx

# Is it expired?
creddy active  # Shows active tokens with expiry
```

### "Connection refused" to proxy

Ensure the proxy is running:
```bash
creddy backend status anthropic
```

Check the port is accessible:
```bash
curl http://creddy-host:8401/health
```

### Streaming not working

Ensure your HTTP client supports SSE and doesn't buffer responses. The proxy passes through `Transfer-Encoding: chunked` and `Content-Type: text/event-stream` correctly.

### Rate limits

Rate limits apply to your underlying Anthropic API key. If you hit limits, all agents using that key are affected. Consider:
- Using separate Anthropic accounts for different environments
- Adding rate limiting at the Creddy proxy level (coming soon)
