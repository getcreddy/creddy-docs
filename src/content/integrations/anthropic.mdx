# Anthropic Integration

Creddy's Anthropic integration creates real, ephemeral API keys on-demand. Unlike proxy-based solutions, agents get actual `sk-ant-...` keys that work with any client.

## How It Works

Anthropic doesn't offer programmatic key creation via API, so Creddy uses browser session automation:

1. You authenticate Creddy with your Anthropic account (one-time setup)
2. Agent requests `creddy get anthropic`
3. Creddy creates a real API key via the Console API
4. Returns `sk-ant-...` key to the agent
5. On TTL expiry or unenroll â†’ Creddy archives the key

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    creddy get anthropic    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚   Creddy    â”‚
â”‚             â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    sk-ant-xxx (1h TTL)     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â”‚
       â”‚ Claude API calls                         â”‚ Console API
       â–¼                                          â”‚ (session auth)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â–¼
â”‚  Anthropic  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     API     â”‚                            â”‚  Anthropic  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   Console   â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

The key difference from proxy solutions: **the agent gets a real API key** that works with any client (Claude Code, SDKs, curl), and Creddy manages its lifecycle.

## Requirements

- Anthropic account (any plan)
- A machine with a browser (laptop/desktop) for initial setup

## Installation

```bash
creddy plugin install anthropic
```

## Server Setup

### 1. Authenticate Creddy

Creddy needs a browser session to create API keys. Run the auth flow from your Creddy server:

```bash
creddy anthropic login
```

This displays a URL and waits for authentication:

```
Waiting for auth...
On your laptop run: npx @creddy/auth http://your-server:8400/v1/auth/anthropic/abc123
```

### 2. Complete Auth on Your Laptop

On a machine with a browser (your laptop), run the provided command:

```bash
npx @creddy/auth http://your-server:8400/v1/auth/anthropic/abc123
```

This:
1. Opens a browser to console.anthropic.com
2. You log in normally (Google, email, 2FA â€” whatever you use)
3. Captures the session cookie
4. Sends it directly to your Creddy server

```
ğŸ” Creddy Auth Helper

Provider: anthropic
Server: http://your-server:8400/v1/auth/anthropic/abc123

Opening browser...
Please log in to Anthropic.

Waiting for login...
âœ“ Login detected!
âœ“ Session sent to Creddy server!
```

Back on your server, you'll see:

```
âœ“ Connected to Anthropic!
Session expires in ~30 days.
```

### 3. Session Renewal

Sessions last approximately 30 days. When expired, run `creddy anthropic login` again.

Creddy will warn you before expiry:
```
âš ï¸ Anthropic session expires in 3 days. Run `creddy anthropic login` to renew.
```

## Agent Enrollment

Agents request Anthropic access during enrollment:

```bash
creddy enroll --server http://creddy:8400 --name my-agent \
  --can anthropic
```

## Requesting Keys

Once enrolled and approved:

```bash
# Get an API key (default 10 min TTL)
creddy get anthropic

# Get a key with custom TTL
creddy get anthropic --ttl 1h

# Use it immediately
export ANTHROPIC_API_KEY=$(creddy get anthropic)
claude "Hello, world"
```

### Using with Claude Code

```bash
export ANTHROPIC_API_KEY=$(creddy get anthropic --ttl 1h)
claude code "implement a fibonacci function"
```

### Using with Python SDK

```python
import anthropic

# Key from environment (set via creddy get)
client = anthropic.Anthropic()

message = client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=1024,
    messages=[{"role": "user", "content": "Hello!"}]
)
```

## Key Lifecycle

### TTL Expiry

Keys are archived when their TTL expires:

```bash
# Request a 30-minute key
creddy get anthropic --ttl 30m

# After 30 minutes, Creddy:
# 1. Sets the key status to "archived" via Admin API
# 2. Removes it from active credentials
```

### Agent Unenroll

When an agent is unenrolled, all their active keys are archived:

```bash
creddy unenroll my-agent
```

This provides immediate revocation.

## Manual Authentication (Fallback)

If you can't use `@creddy/auth` (no browser available, network restrictions), you can manually provide the session:

```bash
creddy anthropic login --manual
```

Then:
1. Log into console.anthropic.com in your browser
2. Open DevTools â†’ Application â†’ Cookies
3. Copy the `sessionKey` value
4. Paste when prompted

## Security Considerations

### Session Security

The Anthropic session stored in Creddy can create API keys. Protect it:

- Run Creddy on a trusted server
- Use Tailscale, VPN, or localhost only
- The session is stored encrypted at rest

### Key Visibility

Anthropic API keys have full access to your API quota. Consider:

- Short TTLs for untrusted agents
- Monitoring usage in console.anthropic.com
- Using separate Anthropic accounts for different trust levels

### Browser Session Risks

The `@creddy/auth` flow:
- Runs entirely on YOUR laptop
- Sends data directly to YOUR Creddy server
- No third-party services involved
- Session cookie is transmitted over HTTPS (if your server uses it)

## Comparison with Static Keys

| Aspect | Static Key | Creddy Ephemeral |
|--------|-----------|------------------|
| Lifetime | Forever | Minutes to hours |
| Revocation | Manual in Console | Automatic on TTL/unenroll |
| Audit | Check Console | Full trail in Creddy |
| Agent compromise | Permanent exposure | Limited window |
| Requires | Console access | One-time auth |

## Troubleshooting

### "Session expired"

Re-authenticate:
```bash
creddy anthropic login
```

### "Failed to create API key"

Check session validity:
```bash
creddy anthropic status
```

If invalid, re-authenticate.

### @creddy/auth can't reach server

Ensure your Creddy server is accessible from your laptop:
- Same network / VPN
- Tailscale
- Port forwarding (temporarily)

### Browser doesn't open

`@creddy/auth` requires a display. If running on a headless machine, use the `--manual` flag instead.
